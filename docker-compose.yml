version: '3.8'

services:
  lnmonja-server:
    build:
      context: .
      dockerfile: deploy/docker/Dockerfile.server
    container_name: lnmonja-server
    ports:
      - "9090:9090"  # gRPC
      - "8080:8080"  # HTTP API
      - "3000:3000"  # WebSocket
    volumes:
      - lnmonja-data:/data
      - ./configs/server-config.yaml:/etc/lnmonja/config.yaml
      - ./configs/alert-rules:/etc/lnmonja/alert-rules
    environment:
      - lnmonja_NODE_ID=server-01
      - lnmonja_STORAGE_PATH=/data
      - lnmonja_LOG_LEVEL=debug
    networks:
      - lnmonja-net
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  lnmonja-agent:
    build:
      context: .
      dockerfile: deploy/docker/Dockerfile.agent
    container_name: lnmonja-agent
    environment:
      - lnmonja_SERVER=lnmonja-server:9090
      - NODE_ID=${HOSTNAME}-docker
    volumes:
      - /:/host:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /sys:/sys:ro
      - /proc:/host/proc:ro
    cap_add:
      - SYS_PTRACE
      - SYS_ADMIN
      - NET_ADMIN
    network_mode: "host"
    pid: "host"
    privileged: true
    restart: unless-stopped
    depends_on:
      lnmonja-server:
        condition: service_healthy

  lnmonja-dashboard:
    image: nginx:alpine
    container_name: lnmonja-dashboard
    ports:
      - "80:80"
    volumes:
      - ./web/dashboard/dist:/usr/share/nginx/html
      - ./deploy/docker/nginx.conf:/etc/nginx/nginx.conf
    environment:
      - API_URL=http://lnmonja-server:8080
      - WS_URL=ws://lnmonja-server:3000
    networks:
      - lnmonja-net
    depends_on:
      - lnmonja-server
    restart: unless-stopped

volumes:
  lnmonja-data:
    driver: local

networks:
  lnmonja-net:
    driver: bridge