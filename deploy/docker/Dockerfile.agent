FROM golang:1.21-alpine AS builder

WORKDIR /app

# Install build dependencies (fix certificate issue)
RUN sed -i 's/https/http/g' /etc/apk/repositories && \
    apk update && \
    apk add --no-cache git gcc musl-dev ca-certificates && \
    sed -i 's/http:/https:/g' /etc/apk/repositories && \
    update-ca-certificates

COPY go.mod go.sum ./

# Download dependencies directly from source (bypass proxy.golang.org certificate issues)
RUN GOPROXY=direct go mod download

COPY . .

# Build with eBPF support
RUN CGO_ENABLED=1 GOOS=linux go build -tags=ebpf -ldflags="-w -s" -o lnmonja-agent ./cmd/lnmonja-agent

# Final stage
FROM alpine:3.18

# Fix certificate issue by using HTTP repos first, then switch to HTTPS
RUN sed -i 's/https/http/g' /etc/apk/repositories && \
    apk update && \
    apk add --no-cache ca-certificates && \
    sed -i 's/http:/https:/g' /etc/apk/repositories

WORKDIR /root/

# Copy binary
COPY --from=builder /app/lnmonja-agent .
COPY --from=builder /app/configs/agent-config.yaml /etc/lnmonja/config.yaml

# Note: Agent needs root privileges for system monitoring
# USER lnmonja

ENTRYPOINT ["./lnmonja-agent"]
CMD ["--config", "/etc/lnmonja/config.yaml"]