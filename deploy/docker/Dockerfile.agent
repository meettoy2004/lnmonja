FROM golang:1.21-alpine AS builder

WORKDIR /app

# Install build dependencies for eBPF
RUN apk add --no-cache git gcc musl-dev clang llvm libbpf-dev linux-headers

COPY go.mod go.sum ./
RUN go mod download

COPY . .

# Build with eBPF support
RUN CGO_ENABLED=1 GOOS=linux go build -tags=ebpf -ldflags="-w -s" -o lnmonja-agent ./cmd/lnmonja-agent

# Final stage
FROM alpine:3.18

# Update and install runtime dependencies
RUN apk update && apk upgrade && \
    apk add --no-cache ca-certificates

WORKDIR /root/

# Copy binary
COPY --from=builder /app/lnmonja-agent .
COPY --from=builder /app/configs/agent-config.yaml /etc/lnmonja/config.yaml

# Note: Agent needs root privileges for system monitoring
# USER lnmonja

ENTRYPOINT ["./lnmonja-agent"]
CMD ["--config", "/etc/lnmonja/config.yaml"]