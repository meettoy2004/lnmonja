FROM golang:1.21-alpine AS builder

WORKDIR /app

# Install build dependencies for eBPF
RUN apk add --no-cache git gcc musl-dev clang llvm libbpf-dev linux-headers

COPY go.mod go.sum ./
RUN go mod download

COPY . .

# Build with eBPF support
RUN CGO_ENABLED=1 GOOS=linux go build -tags=ebpf -ldflags="-w -s" -o lnmonja-agent ./cmd/lnmonja-agent

# Final stage - use distroless for minimal footprint
FROM gcr.io/distroless/base-debian11

# Copy necessary libraries for eBPF
COPY --from=builder /lib/ld-musl-x86_64.so.1 /lib/ld-musl-x86_64.so.1
COPY --from=builder /lib/libc.musl-x86_64.so.1 /lib/libc.musl-x86_64.so.1

WORKDIR /root/

# Copy binary
COPY --from=builder /app/lnmonja-agent .
COPY --from=builder /app/configs/agent-config.yaml /etc/lnmonja/config.yaml

# Create non-root user (distroless has no adduser, but we'll run as non-root numeric)
USER 65534:65534

ENTRYPOINT ["./lnmonja-agent"]
CMD ["--config", "/etc/lnmonja/config.yaml"]